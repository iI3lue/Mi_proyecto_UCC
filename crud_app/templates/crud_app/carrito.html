{% extends 'crud_app/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Carrito de Compras - TechStore{% endblock %}

{% block contenido %}
<div class="container" style="margin-top: 2rem;">
  <h1 class="page-title">ğŸ›’ Carrito de Compras</h1>
  
  {% if productos %}
  <div style="display: grid; grid-template-columns: 1fr 350px; gap: 2rem; align-items: start;">
    <!-- Lista de productos -->
    <div class="cart-container">
      {% for item in productos %}
      <div class="cart-item" id="cart-item-{{ item.producto.pk }}">
        <a href="{% url 'producto_detalle' item.producto.pk %}">
          {% if item.producto.imagen %}
            <img src="{{ item.producto.imagen.url }}" alt="{{ item.producto.nombre }}" class="cart-item-image">
          {% else %}
            <img src="https://via.placeholder.com/100?text=Sin+Imagen" alt="Sin imagen" class="cart-item-image">
          {% endif %}
        </a>
        
        <div class="cart-item-info">
          <h3 class="cart-item-title">
            <a href="{% url 'producto_detalle' item.producto.pk %}" style="color: var(--text-primary); text-decoration: none;">
              {{ item.producto.nombre }}
            </a>
          </h3>
          <p style="color: var(--text-secondary); margin: 0;">{{ item.producto.marca }} â€¢ {{ item.producto.categoria }}</p>
          <p class="cart-item-price">{{ item.producto.precio|currency_cop }} c/u</p>
          
          {% if item.producto.stock < item.cantidad %}
          <p style="color: var(--warning); font-size: 0.85rem; margin-top: 0.5rem;">
            âš ï¸ Solo hay {{ item.producto.stock }} disponibles
          </p>
          {% endif %}
        </div>
        
        <div class="cart-item-actions">
          <div class="quantity-controls">
            <button 
              class="quantity-btn" 
              onclick="updateCartQuantity({{ item.producto.pk }}, -1)"
              aria-label="Disminuir cantidad"
            >
              âˆ’
            </button>
            <span class="quantity-value" id="quantity-{{ item.producto.pk }}">{{ item.cantidad }}</span>
            <button 
              class="quantity-btn" 
              onclick="updateCartQuantity({{ item.producto.pk }}, 1)"
              aria-label="Aumentar cantidad"
              {% if item.cantidad >= item.producto.stock %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}
            >
              +
            </button>
          </div>
          
          <p style="font-weight: 700; font-size: 1.1rem; color: var(--text-primary); margin: 0;" id="subtotal-{{ item.producto.pk }}">
            {{ item.subtotal|currency_cop }}
          </p>
          
          <button 
            class="btn btn-danger btn-sm" 
            onclick="removeFromCart({{ item.producto.pk }})"
            style="padding: 0.4rem 0.8rem;"
          >
            ğŸ—‘ï¸ Eliminar
          </button>
        </div>
      </div>
      {% endfor %}
    </div>
    
    <!-- Resumen del carrito -->
    <div class="cart-summary">
      <h3 style="margin-bottom: 1.5rem; font-size: 1.5rem; color: var(--text-primary);">ğŸ“‹ Resumen del Pedido</h3>
      
      <div class="cart-summary-row">
        <span class="cart-summary-label">Subtotal:</span>
        <span class="cart-summary-value" id="cart-total">{{ total|currency_cop }}</span>
      </div>
      
      <div class="cart-summary-row">
        <span class="cart-summary-label">EnvÃ­o:</span>
        <span class="cart-summary-value" style="color: var(--success);">Gratis ğŸ‰</span>
      </div>
      
      <div class="cart-summary-row cart-total">
        <span class="cart-summary-label">Total:</span>
        <span class="cart-summary-value" id="cart-final-total">{{ total|currency_cop }}</span>
      </div>
      
      {% if user.is_authenticated %}
        <a href="{% url 'checkout' %}" class="btn btn-success" style="width: 100%; margin-top: 1rem; font-size: 1.1rem;">
          ğŸ’³ Proceder al Pago
        </a>
      {% else %}
        <p style="text-align: center; color: var(--text-secondary); margin: 1rem 0;">
          Debes iniciar sesiÃ³n para continuar
        </p>
        <a href="{% url 'login' %}?next={% url 'checkout' %}" class="btn btn-primary" style="width: 100%;">
          Iniciar SesiÃ³n
        </a>
      {% endif %}
      
      <a href="{% url 'lista_productos' %}" class="btn btn-outline" style="width: 100%; margin-top: 0.5rem;">
        â† Seguir Comprando
      </a>
      
      <div style="margin-top: 2rem; padding: 1.25rem; background-color: var(--card-bg); border: 2px solid var(--accent-blue); border-radius: var(--radius-sm);">
        <p style="font-size: 0.95rem; color: var(--text-primary); margin: 0; text-align: center; line-height: 1.8; font-weight: 500;">
          ğŸ”’ Pago 100% seguro<br>
          ğŸšš EnvÃ­o gratis en todos los pedidos<br>
          ğŸ’¯ GarantÃ­a de satisfacciÃ³n<br>
          ğŸ› ï¸ Soporte tÃ©cnico incluido
        </p>
      </div>
    </div>
  </div>
  
  {% else %}
  <div class="empty-state">
    <div class="empty-state-icon">ğŸ›’</div>
    <div class="empty-state-text">Tu carrito estÃ¡ vacÃ­o</div>
    <p style="color: var(--text-secondary); margin-bottom: 2rem;">Â¡Agrega productos para comenzar tu compra!</p>
    <a href="{% url 'lista_productos' %}" class="btn btn-primary btn-lg">Ver Productos</a>
  </div>
  {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
  // Sincronizar total final con subtotal
  function updateTotalDisplay() {
    const subtotal = document.getElementById('cart-total').textContent;
    document.getElementById('cart-final-total').textContent = subtotal;
  }
  
  // Actualizar al cargar la pÃ¡gina
  updateTotalDisplay();
</script>
{% endblock %}
