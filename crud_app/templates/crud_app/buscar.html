{% extends 'crud_app/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Buscar Productos - TechStore{% endblock %}

{% block contenido %}
<div class="container" style="margin-top: 2rem;">
  <h1 class="page-title">üîç Buscar Productos</h1>
  
  <!-- Barra de b√∫squeda y filtros -->
  <div class="search-section">
    <form method="GET" action="{% url 'buscar_productos' %}" id="search-form">
      <div class="search-container">
        <span class="search-icon">üîç</span>
        <input 
          type="text" 
          name="q" 
          class="search-input" 
          placeholder="Buscar por nombre, marca, categor√≠a o especificaciones..."
          value="{{ query }}"
          id="search-input"
        >
        <button type="submit" class="btn btn-primary">Buscar</button>
      </div>
      
      <div class="filter-section">
        <div class="filter-group">
          <label class="filter-label" for="category-filter">Categor√≠a</label>
          <select name="category" id="category-filter" class="filter-select">
            <option value="">Todas las categor√≠as</option>
            {% for cat in categorias %}
              <option value="{{ cat.slug }}" {% if cat.slug == selected_category %}selected{% endif %}>
                {{ cat.icono }} {{ cat.nombre }}
              </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label" for="marca-filter">Marca</label>
          <select name="marca" id="marca-filter" class="filter-select">
            <option value="">Todas las marcas</option>
            {% for marca in marcas %}
              <option value="{{ marca }}" {% if marca == selected_marca %}selected{% endif %}>
                {{ marca }}
              </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label" for="price-filter">Ordenar por precio</label>
          <select name="price" id="price-filter" class="filter-select">
            <option value="">M√°s recientes</option>
            <option value="asc" {% if selected_price == 'asc' %}selected{% endif %}>Menor a mayor</option>
            <option value="desc" {% if selected_price == 'desc' %}selected{% endif %}>Mayor a menor</option>
          </select>
        </div>
      </div>
    </form>
  </div>
  
  <!-- Resultados -->
  {% if query or selected_category or selected_marca %}
  <div style="margin-top: 2rem; padding: 1rem; background-color: var(--secondary-bg); border-radius: var(--radius-md);">
    <p style="margin: 0; color: var(--text-secondary);">
      <strong>{{ productos|length }}</strong> resultado{{ productos|length|pluralize }} encontrado{{ productos|length|pluralize }}
      {% if query %} para "<strong>{{ query }}</strong>"{% endif %}
      {% if selected_category %} en <strong>{{ selected_category }}</strong>{% endif %}
      {% if selected_marca %} de marca <strong>{{ selected_marca }}</strong>{% endif %}
    </p>
  </div>
  {% endif %}
  
  <!-- Grid de productos -->
  {% if productos %}
  <div class="products-grid" style="margin-top: 2rem;">
    {% for producto in productos %}
    <div class="product-card">
      <div class="product-image-container">
        {% if producto.imagen %}
          <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" class="product-image">
        {% else %}
          <img src="https://via.placeholder.com/280x250?text=Sin+Imagen" alt="Sin imagen" class="product-image">
        {% endif %}
        
        <div class="product-badge">{{ producto.marca }}</div>
        
        {% if producto.stock > 0 %}
          {% if producto.stock < 5 %}
            <div class="stock-badge low-stock">Solo {{ producto.stock }} disponibles</div>
          {% else %}
            <div class="stock-badge">En Stock</div>
          {% endif %}
        {% else %}
          <div class="stock-badge out-of-stock">Agotado</div>
        {% endif %}
      </div>
      
      <div class="product-content">
        <div class="product-category">{{ producto.categoria }}</div>
        <h3 class="product-title">{{ producto.nombre }}</h3>
        <div class="product-brand">{{ producto.marca }}</div>
        <p class="product-description">{{ producto.descripcion|truncatewords:15 }}</p>
        
        <div class="product-footer">
          <div class="product-price">
            {{ producto.precio|currency_cop }}
          </div>
          <div style="display: flex; gap: 0.5rem;">
            <a href="{% url 'producto_detalle' producto.pk %}" class="btn btn-outline btn-sm">
              üëÅÔ∏è Ver
            </a>
            {% if producto.stock > 0 %}
              <button onclick="addToCart({{ producto.pk }}, this)" class="btn btn-primary btn-sm">
                üõí Agregar
              </button>
            {% else %}
              <button class="btn btn-sm" disabled style="background-color: var(--border-color); cursor: not-allowed;">
                Agotado
              </button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-state">
    <div class="empty-state-icon">üîç</div>
    <div class="empty-state-text">
      {% if query or selected_category or selected_marca %}
        No se encontraron productos que coincidan con tu b√∫squeda
      {% else %}
        Introduce un t√©rmino de b√∫squeda o selecciona un filtro
      {% endif %}
    </div>
    <a href="{% url 'lista_productos' %}" class="btn btn-primary">Ver todos los productos</a>
  </div>
  {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
  // Auto-submit al cambiar filtros
  document.getElementById('category-filter').addEventListener('change', function() {
    document.getElementById('search-form').submit();
  });
  
  document.getElementById('marca-filter').addEventListener('change', function() {
    document.getElementById('search-form').submit();
  });
  
  document.getElementById('price-filter').addEventListener('change', function() {
    document.getElementById('search-form').submit();
  });
</script>
{% endblock %}
